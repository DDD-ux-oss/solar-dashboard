<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登录系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 图表功能 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 爬虫模拟器 -->
    <script src="crawler_simulator.js"></script>
    <!-- 截图加载辅助工具 -->
    <script src="screenshot_loader.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#6366F1',
            dark: '#1F2937',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
    theme: {
      extend: {
        colors: {
          primary: '#3B82F6',
          secondary: '#10B981',
          accent: '#6366F1',
          dark: '#1F2937',
        },
        fontFamily: {
          inter: ['Inter', 'system-ui', 'sans-serif'],
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .form-input-focus {
        @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium px-4 py-2 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 focus:outline-none;
      }
      .btn-secondary {
        @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-4 py-2 rounded-lg transition-all duration-300 focus:ring-2 focus:ring-gray-400/50 focus:ring-offset-2 focus:outline-none;
      }
      .card {
        @apply bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-100 min-h-screen">
    <!-- 数据更新通知区域 -->
    <div id="data-update-notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center transform translate-y-20 opacity-0 transition-all duration-500 z-50">
        <i class="fa fa-refresh mr-2"></i>
        <span>数据已更新</span>
    </div>
  <!-- 登录页面 -->
  <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
    <div class="card w-full max-w-md p-8">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-sign-in text-primary text-2xl"></i>
        </div>
        <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-dark">用户登录</h1>
        <p class="text-gray-500 mt-2">请输入您的用户名和密码</p>
      </div>
      
      <form id="login-form" class="space-y-4">
        <div class="space-y-2">
          <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa fa-user text-gray-400"></i>
            </div>
            <input type="text" id="username" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg form-input-focus transition-all" placeholder="请输入用户名" required>
          </div>
        </div>
        
        <div class="space-y-2">
          <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa fa-lock text-gray-400"></i>
            </div>
            <input type="password" id="password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg form-input-focus transition-all" placeholder="请输入密码" required>
          </div>
        </div>
        
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <input id="remember-me" type="checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
            <label for="remember-me" class="ml-2 block text-sm text-gray-700">记住我</label>
          </div>
          <div class="text-sm">
            <a href="#" class="font-medium text-primary hover:text-primary/80 transition-colors">忘记密码？</a>
          </div>
        </div>
        
        <button type="submit" class="w-full btn-primary">
          <i class="fa fa-sign-in mr-2"></i>登录
        </button>
      </form>
      
      <div class="mt-6 text-center text-sm text-gray-500">
        还没有账号？ <a href="#" class="font-medium text-primary hover:text-primary/80 transition-colors">立即注册</a>
      </div>
    </div>
  </div>
  
  <!-- 仪表盘页面 (默认隐藏) -->
    <div id="dashboard-page" class="hidden min-h-screen">
      <!-- 最后更新时间显示 -->
      <div class="absolute top-4 right-4 text-sm text-gray-500">
        最后更新时间: <span id="last-update-time">--</span>
      </div>
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-10">
      <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <i class="fa fa-line-chart text-primary text-xl"></i>
          <h1 class="text-lg font-bold text-dark">新鼎能源项目日报</h1>
        </div>
        
        <div class="flex items-center space-x-4">
          <div class="relative">
            <button id="logout-btn" class="btn-secondary">
              <i class="fa fa-sign-out mr-2"></i>退出登录
            </button>
          </div>
        </div>
      </div>
    </header>
    
    <!-- 主内容区域 -->
    <main class="container mx-auto px-4 pt-24 pb-12">
      <div class="card p-6 mb-6">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-dark">项目发电数据报表</h2>
            <div class="text-gray-500 text-sm">
              <span>日期：</span><span id="report-date">2025年9月1日</span><br>
              <span>天气：</span><span id="weather-info">晴转雾 20-31°C</span>
            </div>
          </div>
          
          <div class="flex space-x-2 mb-6">
            <div class="relative">
              <input type="text" id="search-input" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus transition-all w-full md:w-64" placeholder="搜索项目...">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-search text-gray-400"></i>
              </div>
            </div>
            <button id="refresh-btn" class="btn-secondary">
              <i class="fa fa-refresh"></i>
            </button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse table-fixed">
            <thead>
              <tr class="bg-gray-100">
                <th class="px-2 py-2 border border-gray-300 text-left text-sm font-medium text-gray-700" width="15%">项目名称</th>
                <th class="px-2 py-2 border border-gray-300 text-right text-sm font-medium text-gray-700" width="10%">直流测容量(MWp)</th>
                <th class="px-2 py-2 border border-gray-300 text-right text-sm font-medium text-gray-700" width="10%">交流测容量(MW)</th>
                <th class="px-2 py-2 border border-gray-300 text-right text-sm font-medium text-gray-700" width="12%">本日发电量(kWh)</th>
                <th class="py-2 border border-gray-300 text-center text-sm font-medium text-gray-700" width="33%">今日发电曲线</th>
                <th class="px-2 py-2 border border-gray-300 text-center text-sm font-medium text-gray-700" width="10%">等效利用小时</th>
                <th class="px-2 py-2 border border-gray-300 text-center text-sm font-medium text-gray-700" width="10%">平均利用小时</th>
              </tr>
            </thead>
            <tbody id="data-table-body" class="bg-white">
              <!-- 表格数据将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 日报说明 -->
        <div class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
          <p class="text-sm text-gray-700" id="report-summary">
            本日天气晴转雾后，各光伏项目发电效能显著回升，等效利用小时均值达5.83h。滨北南邱家以6.29h领跑，梁才宋滩(6.21h)同步恢复高效运行，零碳商业园仍严重滞后。
          </p>
        </div>
        
        <!-- 调试信息区域 -->
        <div class="mt-6 bg-gray-900 p-4 rounded-lg border border-gray-700">
          <h3 class="text-sm font-medium text-green-400 mb-2">调试信息</h3>
          <div id="debug-info" class="text-xs text-gray-300 font-mono max-h-40 overflow-y-auto whitespace-pre-wrap">
            <!-- 调试信息将通过JavaScript动态添加 -->
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- JavaScript -->
  <script>
    // 调试日志函数 - 将日志同时输出到控制台和页面调试区域
    function debugLog(message) {
      // 输出到控制台
      console.log(message);
      
      // 输出到页面调试区域
      const debugInfo = document.getElementById('debug-info');
      if (debugInfo) {
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
        // 自动滚动到底部
        debugInfo.scrollTop = debugInfo.scrollHeight;
      }
    }
    
    // 项目容量基础数据（这些数据相对稳定，从原始数据中保留）
    const baseProjectData = [
      { id: 1, name: '梁才宋滩', dcCapacity: 5.9826, acCapacity: 4.77 },
      { id: 2, name: '杨柳雪李赞皇', dcCapacity: 1.94346, acCapacity: 1.7 },
      { id: 3, name: '滨北南邱家', dcCapacity: 5.3749, acCapacity: 4.3 },
      { id: 4, name: '水立方', dcCapacity: 1.16938, acCapacity: 1 },
      { id: 5, name: '黄河植物园', dcCapacity: 0.10384, acCapacity: 0.1 },
      { id: 6, name: '零碳商业园', dcCapacity: 1.65008, acCapacity: 1.58858 }
    ];
    
    // 从爬虫数据文件加载的实时数据
    let energyProjectData = [];
    let filteredData = [];
    
    // 生成日期信息
    const today = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('report-date').textContent = today.toLocaleDateString('zh-CN', options);
    
    // DOM元素
    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const dataTableBody = document.getElementById('data-table-body');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const showingCountEl = document.getElementById('showing-count');
    const totalCountEl = document.getElementById('total-count');
    
    // 登录处理
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // 简单的登录验证（实际项目中应该发送到服务器验证）
      if (username && password) {
        // 显示仪表盘
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        
        // 渲染表格数据
        renderTableData();
        
        // 保存登录状态到localStorage
        localStorage.setItem('isLoggedIn', 'true');
      } else {
        alert('请输入用户名和密码');
      }
    });
    
    // 退出登录处理
    logoutBtn.addEventListener('click', function() {
      // 清除登录状态
      localStorage.removeItem('isLoggedIn');
      
      // 显示登录页面
      dashboardPage.classList.add('hidden');
      loginPage.classList.remove('hidden');
      
      // 重置表单
      loginForm.reset();
    });
    
    // 搜索功能
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      // 过滤数据
      filteredData = energyProjectData.filter(project => 
        project.name.toLowerCase().includes(searchTerm)
      );
      
      // 重新渲染表格
      renderTableData();
    });
    
    // 刷新按钮
    refreshBtn.addEventListener('click', function() {
      // 重置搜索
      searchInput.value = '';
      
      // 检查并重新加载爬虫数据
      checkAndLoadCrawlerData().catch(error => {
        console.error('刷新数据失败:', error);
        // 如果刷新失败，使用当前已加载的数据重新渲染
        renderTableData();
      });
      
      // 添加刷新动画效果
      this.classList.add('animate-spin');
      setTimeout(() => {
        this.classList.remove('animate-spin');
      }, 500);
    });
    
    // 生成发电曲线SVG或加载本地截图
    function generatePowerCurveSVG(projectId) {
        // 尝试加载多种可能的截图路径
        const today = new Date();
        const dateStr = today.getFullYear() + 
                       String(today.getMonth() + 1).padStart(2, '0') + 
                       String(today.getDate()).padStart(2, '0');
        const timestamp = new Date().getTime();
        
        // 根据项目ID设置不同的图片路径
        let screenshotPaths = [];
        if (projectId === 5) {
            // 黄河植物园项目 - 优先加载固定名称的截图
            screenshotPaths = [
                `screenshots/power_curve_5.png`,
                `screenshots/sems_element_goodwe-station-charts__chart_${dateStr}_*.png`,
                `screenshots/sems_element_goodwe-station-charts__chart_*.png`
            ];
        } else {
            // 其他项目使用原有命名规则
            screenshotPaths = [
                `screenshots/power_curve_${projectId}.png`,
                `screenshots/sems_screenshot_${dateStr}_*.png`
            ];
        }
        
        // 返回HTML字符串只包含截图，不包含SVG回退方案
        return `
            <div class="power-curve-container" data-project-id="${projectId}">
                <img 
                    class="power-curve-image" 
                    alt="项目 ${projectId} 今日发电曲线" 
                    src="${screenshotPaths[0]}?t=${timestamp}" 
                    style="width: 100%; max-height: 300px; object-fit: contain;" 
                    onload="hideOtherImages(this)" 
                    onerror="loadFallbackImage(this, ${projectId})"
                />
            </div>
        `;
    }
    
    // 增强版发电曲线生成函数 - 用于黄河植物园项目
    function enhancedGeneratePowerCurveSVG(projectId) {
        // 返回HTML字符串只包含截图，不包含SVG回退方案
        const timestamp = new Date().getTime();
        return `
            <div class="power-curve-container" data-project-id="5">
                <img 
                    class="power-curve-image" 
                    alt="黄河植物园今日发电曲线" 
                    src="screenshots/power_curve_5.png?t=${timestamp}" 
                    style="width: 100%; max-height: 300px; object-fit: contain;" 
                    onload="hideOtherImages(this)" 
                    onerror="loadFallbackImage(this, 5)"
                />
            </div>
        `;
    }
    
    // 辅助函数：当一个图片加载成功时，隐藏其他图片
    function hideOtherImages(loadedImg) {
      const parent = loadedImg.parentNode;
      const otherImages = parent.querySelectorAll('img');
      otherImages.forEach(img => {
        if (img !== loadedImg) {
          img.style.display = 'none';
        }
      });
    }
    
    // 当主图片加载失败时，加载备选图片
    function loadFallbackImage(imgElement, projectId) {
      // 获取当前日期
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      
      // 备选图片路径
      const fallbackPaths = [
        `screenshots/power_curve_${projectId}.png`,
        `screenshots/power_curve_${projectId}_${dateStr}.png`,
        `screenshots/after_login_debug.png`
      ];
      
      // 尝试加载备选图片
      for (let i = 0; i < fallbackPaths.length; i++) {
        const fallbackImg = new Image();
        fallbackImg.onload = function() {
          imgElement.src = fallbackPaths[i] + '?t=' + new Date().getTime();
          imgElement.style.display = 'block';
        };
        fallbackImg.src = fallbackPaths[i] + '?t=' + new Date().getTime();
      }
    }
    
    // 渲染表格数据 - 调用带更新数据的渲染函数
    function renderTableData() {
      // 计算总发电量
      const currentTotalGeneration = energyProjectData.reduce((sum, project) => sum + project.dailyGeneration, 0);
      
      // 调用带更新数据的渲染函数
      renderTableDataWithUpdatedData(filteredData, currentTotalGeneration);
    }
    
    // 页面加载时直接尝试加载太阳能数据
    document.addEventListener('DOMContentLoaded', function() {
      // 尝试直接加载太阳能数据（无论登录状态如何）
      loadSolarDataFromJson().then(jsonData => {
        if (jsonData && jsonData.length > 0) {
          console.log('预加载太阳能数据成功');
        }
      }).catch(error => {
        console.log('预加载太阳能数据失败，将在登录后重试');
      });
    });
    
    // 检查并加载本地爬虫数据
    async function checkAndLoadCrawlerData() {
      // 首先尝试从JSON文件加载实际的发电数据
      try {
        const jsonData = await loadSolarDataFromJson();
        if (jsonData && jsonData.length > 0) {
          // 有真实的JSON数据
          console.log(`从JSON文件加载到 ${jsonData.length} 个项目的实际数据`);
          updateDashboardData(jsonData);
          return;
        }
      } catch (error) {
        console.error('加载JSON数据失败:', error);
      }
      
      // 如果JSON数据加载失败，检查是否有爬虫截图文件存在
      const projectsWithScreenshots = [];
      
      for (const project of baseProjectData) {
        const screenshotPath = `screenshots/power_curve_${project.id}.png`;
        
        // 创建一个Promise来检查文件是否存在
        const fileExists = await new Promise(resolve => {
          const xhr = new XMLHttpRequest();
          xhr.open('HEAD', screenshotPath, true);
          xhr.onload = function() {
            resolve(xhr.status === 200);
          };
          xhr.onerror = function() {
            resolve(false);
          };
          xhr.send();
        });
        
        if (fileExists) {
          projectsWithScreenshots.push(project.id);
        }
      }
      
      console.log(`找到 ${projectsWithScreenshots.length} 个项目的爬虫截图`);
      
      // 根据是否有爬虫数据决定使用哪种方式初始化数据
      if (projectsWithScreenshots.length > 0) {
        // 有爬虫数据，使用这些项目的数据
        loadDashboardWithCrawlerData();
      } else {
        // 没有爬虫数据，使用默认的占位数据
        loadDashboardWithDefaultData();
      }
    }
    
    // 从JSON文件加载太阳能数据
    async function loadSolarDataFromJson() {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'solar_data.json?t=' + new Date().getTime(), true);
        xhr.responseType = 'json';
        
        xhr.onload = function() {
          if (xhr.status === 200 && xhr.response) {
            debugLog('原始JSON数据: ' + JSON.stringify(xhr.response));
            
            // 检查是否有嵌套的数据字段
            if (xhr.response.data) {
              debugLog('提取嵌套数据: ' + JSON.stringify(xhr.response.data));
              // 在控制台显示每个项目的dailyGeneration值
              if (Array.isArray(xhr.response.data)) {
                xhr.response.data.forEach(project => {
                  debugLog(`项目 ${project.id} (${project.name}): dailyGeneration = ${project.dailyGeneration}`);
                });
              }
              resolve(xhr.response.data);
            } else {
              // 如果没有嵌套的data字段，直接使用response
              if (Array.isArray(xhr.response)) {
                // 在控制台显示每个项目的dailyGeneration值
                xhr.response.forEach(project => {
                  debugLog(`项目 ${project.id} (${project.name}): dailyGeneration = ${project.dailyGeneration}`);
                });
              }
              resolve(xhr.response);
            }
          } else {
          debugLog('无法加载JSON数据，状态码: ' + xhr.status);
          reject(new Error(`无法加载JSON数据，状态码: ${xhr.status}`));
        }
        };
        
        xhr.onerror = function() {
          debugLog('加载JSON数据时发生网络错误');
          reject(new Error('加载JSON数据时发生网络错误'));
        };
        
        xhr.send();
      });
    }
    
    // 加载爬虫数据到仪表盘
    function loadDashboardWithCrawlerData() {
      console.log('正在加载爬虫数据...');
      
      // 为每个项目创建完整的数据对象
      energyProjectData = baseProjectData.map(project => {
        // 假设我们从本地文件或其他方式获取实时数据
        // 在实际场景中，这里可能需要从后端API或本地JSON文件获取数据
        // 这里我们暂时使用一些合理的默认值，实际应用中应该替换为真实数据来源
        const dailyGeneration = project.dcCapacity * 5.5 * 1000; // 简单估算
        
        // 计算等效利用小时：日发电量 / 直流侧容量 / 1000
        const efficiencyHours = dailyGeneration / project.dcCapacity / 1000;
        
        // 计算效率颜色
        let efficiencyColor = 'bg-green-500'; // 默认绿色
        if (efficiencyHours < 5.5) {
          efficiencyColor = 'bg-yellow-400'; // 黄色
        }
        if (efficiencyHours < 5.0) {
          efficiencyColor = 'bg-red-500'; // 红色
        }
        
        // 只有前五个项目显示平均利用小时
        const avgEfficiencyHours = project.id <= 5 ? 5.83 : null;
        
        return {
          ...project,
          dailyGeneration: dailyGeneration,
          efficiencyHours: efficiencyHours,
          avgEfficiencyHours: avgEfficiencyHours,
          efficiencyColor: efficiencyColor
        };
      });
      
      filteredData = [...energyProjectData];
      renderTableData();
      
      console.log('爬虫数据加载完成');
    }
    
    // 加载默认数据到仪表盘
    function loadDashboardWithDefaultData() {
      console.log('正在加载默认数据...');
      
      // 使用默认的占位数据
      energyProjectData = baseProjectData.map(project => {
        const dailyGeneration = 0;
        // 计算等效利用小时：日发电量 / 直流侧容量 / 1000
        const efficiencyHours = dailyGeneration / project.dcCapacity / 1000;
        const efficiencyColor = 'bg-gray-400';
        const avgEfficiencyHours = project.id <= 5 ? 0 : null;
        
        return {
          ...project,
          dailyGeneration: dailyGeneration,
          efficiencyHours: efficiencyHours,
          avgEfficiencyHours: avgEfficiencyHours,
          efficiencyColor: efficiencyColor
        };
      });
      
      filteredData = [...energyProjectData];
      renderTableData();
      
      console.log('默认数据加载完成');
    }
    
    // 使用从JSON加载的实际数据更新仪表盘
    function updateDashboardData(jsonData) {
      debugLog('接收到的JSON数据数组: ' + JSON.stringify(jsonData));
      
      // 确保JSON数据格式正确
      if (jsonData && jsonData.data && Array.isArray(jsonData.data)) {
        // 如果JSON数据有嵌套的data字段，使用它
        jsonData = jsonData.data;
      }
      
      // 确保jsonData是数组
      if (!Array.isArray(jsonData)) {
        console.error('JSON数据格式不正确，不是数组:', jsonData);
        return;
      }
      
      // 创建包含实际数据的项目数组
      energyProjectData = jsonData.map(projectData => {
        console.log('处理项目数据:', projectData.id, projectData.name, 'dailyGeneration:', projectData.dailyGeneration);
        
        // 确保使用JSON数据中的dailyGeneration值，即使为0
        const dailyGeneration = projectData.dailyGeneration !== undefined ? projectData.dailyGeneration : 0;
        
        // 找到对应的基础项目数据
        const baseProject = baseProjectData.find(p => p.id === projectData.id) || {};
        
        // 优先使用JSON数据中的项目名称
        const projectName = projectData.name || baseProject.name || `项目${projectData.id}`;
        
        // 获取容量数据，如果JSON中没有则使用基础数据
        const dcCapacity = projectData.dcCapacity !== undefined ? projectData.dcCapacity : (baseProject.dcCapacity || 0);
        const acCapacity = projectData.acCapacity !== undefined ? projectData.acCapacity : (baseProject.acCapacity || 0);
        
        // 始终使用正确的算法计算效率小时数：日发电量 / 直流容量 / 1000
        let efficiencyHours = 0;
        if (dcCapacity && dailyGeneration) {
          efficiencyHours = parseFloat((dailyGeneration / dcCapacity / 1000).toFixed(2));
        }
        
        // 使用JSON数据中提供的效率颜色，如果没有则计算
        let efficiencyColor = projectData.efficiencyColor;
        if (!efficiencyColor) {
          efficiencyColor = 'bg-green-500'; // 默认绿色
          if (efficiencyHours < 5.5) {
            efficiencyColor = 'bg-yellow-400'; // 黄色
          }
          if (efficiencyHours < 5.0) {
            efficiencyColor = 'bg-red-500'; // 红色
          }
        }
        
        // 只有前五个项目显示平均利用小时
        const avgEfficiencyHours = projectData.id <= 5 ? 5.83 : null;
        
        return {
          id: projectData.id,
          name: projectName,
          dcCapacity: dcCapacity,
          acCapacity: acCapacity,
          dailyGeneration: dailyGeneration,
          efficiencyHours: efficiencyHours,
          efficiencyColor: efficiencyColor,
          avgEfficiencyHours: avgEfficiencyHours,
          date: projectData.date || new Date().toISOString().split('T')[0],
          isSimulated: false, // 标记为真实数据
          power_curve: projectData.power_curve || { data_points: [] }
        };
      });
      
      filteredData = [...energyProjectData];
      
      console.log('最终处理后的项目数据:', energyProjectData);
      
      // 计算总发电量
      const updatedTotalGeneration = energyProjectData.reduce((sum, project) => sum + project.dailyGeneration, 0);
      
      console.log('总发电量:', updatedTotalGeneration);
      
      // 重新渲染表格时使用更新后的数据
      renderTableDataWithUpdatedData(energyProjectData, updatedTotalGeneration);
      
      // 更新最后更新时间
      const lastUpdateElem = document.getElementById('last-update-time');
      if (lastUpdateElem) {
        lastUpdateElem.textContent = new Date().toLocaleString();
      }
      
      // 显示数据更新通知
      showDataUpdateNotification();
    }
    
    // 带更新数据的表格渲染函数
    // 使用更新后的数据渲染表格
    function renderTableDataWithUpdatedData(projects, totalGen) {
      const dataTableBody = document.getElementById('data-table-body');
      if (!dataTableBody) {
        console.error('找不到数据表格体');
        return;
      }
      
      // 清空表格内容
      dataTableBody.innerHTML = '';
      
      if (!projects || projects.length === 0) {
        // 显示空数据状态
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="7" class="px-4 py-8 text-center text-gray-500">暂无数据</td>
        `;
        dataTableBody.appendChild(emptyRow);
      } else {
        // 计算所有六个项目的等效利用小时平均值
        const totalEfficiencyHours = projects.reduce((sum, project) => sum + parseFloat(project.efficiencyHours || 0), 0);
        const avgEfficiencyHours = (totalEfficiencyHours / projects.length).toFixed(2);
        
        // 添加数据行
        projects.forEach((project, index) => {
          console.log(`渲染项目数据 - ID:${project.id}, 名称:${project.name}, 日发电量:${project.dailyGeneration}`);
          
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 transition-colors';
          
          // 移除特殊样式，所有项目使用统一字体
          const dailyGenerationClass = '';
          
          // 检查是否是第一个项目
          if (index === 0) {
            // 第一个项目显示合并的单元格和平均值
            row.innerHTML = `
              <td class="px-4 py-3 border border-gray-300 text-sm">${project.name}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right">${project.dcCapacity.toFixed(4)}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right">${project.acCapacity.toFixed(2)}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right ${dailyGenerationClass}">${project.dailyGeneration.toFixed(2)}</td>
              <td class="px-4 py-3 border border-gray-300">${project.id === 5 ? enhancedGeneratePowerCurveSVG(project.id) : generatePowerCurveSVG(project.id)}</td>
              <td class="px-4 py-3 border border-gray-300 text-center text-sm font-medium text-white ${project.efficiencyColor}">${project.efficiencyHours.toFixed(2)}</td>
              <td class="px-4 py-3 border border-gray-300 text-center text-sm font-medium" rowspan="6">${avgEfficiencyHours}</td>
            `;
          } else {
            // 其他五个项目不显示最后一列
            row.innerHTML = `
              <td class="px-4 py-3 border border-gray-300 text-sm">${project.name}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right">${project.dcCapacity.toFixed(4)}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right">${project.acCapacity.toFixed(2)}</td>
              <td class="px-4 py-3 border border-gray-300 text-sm text-right ${dailyGenerationClass}">${project.dailyGeneration.toFixed(2)}</td>
              <td class="px-4 py-3 border border-gray-300">${project.id === 5 ? enhancedGeneratePowerCurveSVG(project.id) : generatePowerCurveSVG(project.id)}</td>
              <td class="px-4 py-3 border border-gray-300 text-center text-sm font-medium text-white ${project.efficiencyColor}">${project.efficiencyHours.toFixed(2)}</td>
            `;
          }
          
          dataTableBody.appendChild(row);
        });
        
        // 添加总计行
        const totalRow = document.createElement('tr');
        totalRow.className = 'bg-gray-50';
        totalRow.innerHTML = `
          <td class="px-4 py-3 border border-gray-300 text-sm font-medium">本日合计发电量</td>
          <td class="px-4 py-3 border border-gray-300"></td>
          <td class="px-4 py-3 border border-gray-300"></td>
          <td class="px-4 py-3 border border-gray-300 text-sm text-right font-medium">${totalGen.toFixed(2)}</td>
          <td class="px-4 py-3 border border-gray-300"></td>
          <td class="px-4 py-3 border border-gray-300"></td>
          <td class="px-4 py-3 border border-gray-300"></td>
        `;
        
        dataTableBody.appendChild(totalRow);
      }
    }
    
    // 显示数据更新通知
    function showDataUpdateNotification() {
      const notification = document.getElementById('data-update-notification');
      if (notification) {
        // 显示通知
        notification.classList.remove('translate-y-20', 'opacity-0');
        notification.classList.add('translate-y-0', 'opacity-100');
        
        // 3秒后隐藏通知
        setTimeout(() => {
          notification.classList.remove('translate-y-0', 'opacity-100');
          notification.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
      }
    }
    
    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', function() {
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      
      if (isLoggedIn) {
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        
        // 更新最后更新时间
        const lastUpdateElem = document.getElementById('last-update-time');
        if (lastUpdateElem) {
          lastUpdateElem.textContent = new Date().toLocaleString();
        }
        
        // 检查并加载本地爬虫数据
        checkAndLoadCrawlerData().catch(error => {
          console.error('加载数据失败:', error);
          // 如果获取失败，使用默认占位数据
          loadDashboardWithDefaultData();
        });
      }
      
      // 移除了爬虫模拟器初始化，因为我们现在使用真实的爬虫数据
    });
  </script>
</body>
</html>