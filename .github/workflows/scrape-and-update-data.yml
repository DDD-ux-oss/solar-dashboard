name: 太阳能数据爬虫与更新

on:
  # 定期执行 - 每天北京时间上午9:30执行（UTC时间凌晨1:30）
  schedule:
    - cron: '30 1 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest

    steps:
      # 步骤1: 检出代码仓库
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2: 设置Python环境
      - name: 设置Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # 步骤3: 安装系统依赖（Chrome浏览器和驱动）
      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip libxss1 libxtst6 libxrandr2 libasound2t64 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 libgdk-pixbuf2.0-0
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          sudo apt-get install -y chromium-chromedriver

      # 步骤4: 检查CI环境预装包
      - name: 检查CI环境预装包
        run: |
          echo "=== 检查CI环境预装包情况 ==="
          python check_ci_packages.py

      # 步骤5: 安装Python依赖
      - name: 安装Python依赖
        run: |
          which python
          python --version
          which python3
          python3 --version

          python -m pip install --upgrade pip
          python3 -m pip install --upgrade pip

          pip install -r requirements.txt
          pip3 install -r requirements.txt
          pip install webdriver-manager
          pip3 install webdriver-manager

          python3 -c "import requests; print('Python3 requests安装成功')" || echo "Python3 requests导入失败"
          python3 -c "import selenium; print('Python3 selenium安装成功')" || echo "Python3 selenium导入失败"
          python3 -c "import easyocr; print('Python3 easyocr安装成功')" || echo "Python3 easyocr导入失败"

          pip3 list

      # 步骤6: 运行太阳能数据爬虫
      - name: 运行太阳能数据爬虫
        env:
          HUAWEI_USERNAME: ${{ secrets.HUAWEI_USERNAME }}
          HUAWEI_PASSWORD: ${{ secrets.HUAWEI_PASSWORD }}
          SEMS_USERNAME: ${{ secrets.SEMS_USERNAME }}
          SEMS_PASSWORD: ${{ secrets.SEMS_PASSWORD }}
          ESOLAR_USERNAME: ${{ secrets.ESOLAR_USERNAME }}
          ESOLAR_PASSWORD: ${{ secrets.ESOLAR_PASSWORD }}
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

          echo "=== 检查Python环境 ==="
          which python3
          python3 --version
          python3 -c "import sys; print('Python3路径:', sys.executable)"
          python3 -c "import requests; print('Python3 requests模块可用')" || echo "ERROR: requests模块不可用"

          echo "=== 运行爬虫脚本 ==="
          python3 update_solar_dashboard.py || {
            echo "ERROR: 脚本运行失败"
            exit 1
          }

      # 步骤7: 检查数据是否更新
      - name: 检查数据更新
        run: |
          if [ -s solar_data.json ]; then
            echo "数据文件存在且不为空"
            cat solar_data.json
          else
            echo "数据文件不存在或为空，退出工作流"
            exit 1
          fi

      # 步骤8: 提交更新的数据文件到仓库
      - name: 提交数据更新
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add solar_data.json screenshots/
          git status

          if ! git diff --staged --quiet; then
            git commit -m "自动化更新太阳能数据 $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "数据已成功更新并推送到仓库"
          else
            echo "没有检测到数据更改，跳过提交"
          fi
