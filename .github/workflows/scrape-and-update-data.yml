name: 太阳能数据爬虫与更新

# 定义工作流触发条件
on:
  # 定期执行 - 每天北京时间上午9:30执行（UTC时间凌晨1:30）
  # 如需修改执行时间，请调整cron表达式
  # cron格式: 分钟 小时 日期 月份 星期几
  # 例如: '0 0 * * *' 表示UTC时间每天午夜（北京时间早上8点）
  # 例如: '0 12 * * *' 表示UTC时间每天中午（北京时间晚上8点）
  schedule:
    - cron: '30 1 * * *'
  # 允许手动触发
  workflow_dispatch:

# 定义工作流任务
jobs:
  scrape-and-update:
    # 在最新的Ubuntu环境中运行
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1: 检出代码仓库
      - name: 检出代码
        uses: actions/checkout@v3
        
      # 步骤2: 设置Python环境
      - name: 设置Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'  # 启用pip缓存以加速安装
          
      # 步骤3: 安装系统依赖（Chrome浏览器和驱动）
      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip libxss1 libgconf-2-4 libxtst6 libxrandr2 libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 libgdk-pixbuf2.0-0
          # 安装Chrome浏览器
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          # 安装ChromeDriver
          sudo apt-get install -y chromium-chromedriver
          
      # 步骤4: 安装Python依赖
      - name: 安装Python依赖
        run: |
          # 确保使用正确的Python路径
          which python
          python --version
          which python3
          python3 --version
          
          # 升级pip
          python -m pip install --upgrade pip
          python3 -m pip install --upgrade pip
          
          # 安装依赖包
          pip install -r requirements.txt
          pip3 install -r requirements.txt
          
          # 在CI环境中安装额外的浏览器驱动支持
          pip install webdriver-manager
          pip3 install webdriver-manager
          
          # 验证关键依赖是否安装成功
          python -c "import requests; print('requests安装成功')" || echo "Python requests导入失败"
          python3 -c "import requests; print('Python3 requests安装成功')" || echo "Python3 requests导入失败"
          
          python -c "import selenium; print('selenium安装成功')" || echo "Python selenium导入失败"
          python3 -c "import selenium; print('Python3 selenium安装成功')" || echo "Python3 selenium导入失败"
          
          python -c "import easyocr; print('easyocr安装成功')" || echo "Python easyocr导入失败"
          python3 -c "import easyocr; print('Python3 easyocr安装成功')" || echo "Python3 easyocr导入失败"
          
          # 显示pip版本信息和已安装的包列表
          pip --version || echo "pip命令失败"
          pip3 --version || echo "pip3命令失败"
          pip list || echo "pip list失败"
          pip3 list || echo "pip3 list失败"
          
      # 步骤5: 运行爬虫脚本
        - name: 运行太阳能数据爬虫
          env:
            # 从GitHub Secrets中获取敏感信息
            HUAWEI_USERNAME: ${{ secrets.HUAWEI_USERNAME }}
            HUAWEI_PASSWORD: ${{ secrets.HUAWEI_PASSWORD }}
            SEMS_USERNAME: ${{ secrets.SEMS_USERNAME }}
            SEMS_PASSWORD: ${{ secrets.SEMS_PASSWORD }}
            ESOLAR_USERNAME: ${{ secrets.ESOLAR_USERNAME }}
            ESOLAR_PASSWORD: ${{ secrets.ESOLAR_PASSWORD }}
          run: |
            # 设置显示环境，用于Chrome运行
            export DISPLAY=:99
            Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
            
            # 检查Python环境和依赖
            echo "=== 检查Python环境 ==="
            which python
            python --version
            python -c "import sys; print('Python路径:', sys.executable)"
            python -c "import requests; print('requests模块可用')" || echo "ERROR: requests模块不可用"
            
            which python3
            python3 --version
            python3 -c "import sys; print('Python3路径:', sys.executable)"
            python3 -c "import requests; print('Python3 requests模块可用')" || echo "ERROR: Python3 requests模块不可用"
            
            echo "=== 运行爬虫脚本 ==="
            # 尝试使用python3运行脚本
            python3 update_solar_dashboard.py || {
              echo "Python3运行失败，尝试使用python运行"
              python update_solar_dashboard.py || {
                echo "ERROR: 脚本运行失败"
                exit 1
              }
            }
          
      # 步骤6: 检查数据是否更新
      - name: 检查数据更新
        run: |
          # 检查solar_data.json文件是否存在且不为空
          if [ -s solar_data.json ]; then
            echo "数据文件存在且不为空"
            cat solar_data.json
          else
            echo "数据文件不存在或为空，退出工作流"
            exit 1
          fi
          
      # 步骤7: 提交更新的数据文件到仓库
      - name: 提交数据更新
        run: |
          # 配置Git用户信息
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 检查是否有更改
          git add solar_data.json screenshots/
          git status
          
          # 如果有更改，提交并推送
          if ! git diff --staged --quiet; then
            git commit -m "自动化更新太阳能数据 $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "数据已成功更新并推送到仓库"
          else
            echo "没有检测到数据更改，跳过提交"
          fi