name: 太阳能数据爬虫与更新

on:
  # 定期执行 - 每天北京时间上午9:30执行（UTC时间凌晨1:30）
  schedule:
    - cron: '30 1 * * *'
  # 允许手动触发
  workflow_dispatch:

permissions:
  contents: write
jobs:
  scrape-and-update:
    runs-on: ubuntu-latest

    steps:
      # 步骤1: 检出代码仓库
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 步骤2: 设置Python环境
      - name: 设置Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # 步骤3: 修改DNS配置和Hosts文件（解决域名解析问题）
      - name: 修改DNS配置
        run: |
          sudo rm -f /etc/resolv.conf
          # 尝试使用多个DNS服务器
          sudo bash -c 'echo "nameserver 8.8.8.8" > /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 8.8.4.4" >> /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 1.1.1.1" >> /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 1.0.0.1" >> /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 208.67.222.222" >> /etc/resolv.conf'
          sudo bash -c 'echo "nameserver 208.67.220.220" >> /etc/resolv.conf'
          cat /etc/resolv.conf
          
          # 修改hosts文件，手动设置华为FusionSolar网站的域名解析
          # 使用已知的华为云服务器IP地址
          sudo tee -a /etc/hosts << EOF
185.176.7.22    intl.fusionsolar.huawei.com
185.176.7.23    intl.fusionsolar.huawei.com
49.4.85.86      intl.fusionsolar.huawei.com
49.4.85.87      intl.fusionsolar.huawei.com
185.176.7.22    fusionsolar.huawei.com
185.176.7.23    fusionsolar.huawei.com
49.4.85.86      fusionsolar.huawei.com
49.4.85.87      fusionsolar.huawei.com
185.176.7.22    uni01cn.fusionsolar.huawei.com
185.176.7.23    uni01cn.fusionsolar.huawei.com
49.4.85.86      uni01cn.fusionsolar.huawei.com
49.4.85.87      uni01cn.fusionsolar.huawei.com
EOF
          # 验证hosts文件
          cat /etc/hosts

      # 步骤4: 安装系统依赖（Chrome浏览器和驱动）
      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip libxss1 libxtst6 libxrandr2 libasound2t64 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 libgdk-pixbuf2.0-0
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          sudo apt-get install -y chromium-chromedriver

      # 步骤5: 测试DNS解析
      - name: 测试DNS解析
        run: |
          # 测试华为域名解析
          nslookup intl.fusionsolar.huawei.com
          nslookup huawei.com
          
          # 测试公共域名作为对照
          nslookup github.com
          nslookup google.com

      # 步骤6: 测试网络连接
      - name: 测试网络连接
        run: |
          # 移除ping测试，因为GitHub Actions环境可能限制ICMP流量
          echo "跳过ping测试（GitHub Actions可能限制ICMP流量）"
          curl -v https://intl.fusionsolar.huawei.com 2>&1 | head -50 || echo "curl测试失败，但继续执行工作流"
          
      # 步骤7: 测试Chrome浏览器的DNS解析
      - name: 测试Chrome浏览器的DNS解析
        run: |
          echo "=== 测试Chrome浏览器的DNS解析 ==="
          # 创建一个Python脚本测试Chrome的DNS解析
          cat > test_chrome_dns.py << 'EOF'
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          import logging
          
          # 配置日志
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger(__name__)
          
          # 配置Chrome选项
          chrome_options = Options()
          chrome_options.add_argument('--headless')
          chrome_options.add_argument('--no-sandbox')
          chrome_options.add_argument('--disable-dev-shm-usage')
          chrome_options.add_argument('--dns-servers=8.8.8.8,8.8.4.4')
          
          try:
              # 启动Chrome浏览器
              logger.info("启动Chrome浏览器...")
              driver = webdriver.Chrome(options=chrome_options)
              
              # 使用Chrome DevTools Protocol测试DNS解析
              logger.info("测试Chrome浏览器的DNS解析...")
              domains_to_test = ['intl.fusionsolar.huawei.com', 'huawei.com', 'github.com']
              
              for domain in domains_to_test:
                  try:
                      # 尝试使用CDP的Network.enable和Network.getDNSResolveCache方法
                      # 注意：这个API可能在不同Chrome版本中有变化
                      driver.execute_cdp_cmd('Network.enable', {})
                      
                      # 尝试访问域名
                      logger.info(f"尝试访问: {domain}")
                      driver.get(f'https://{domain}')
                      
                      # 获取当前URL来检查是否成功
                      current_url = driver.current_url
                      logger.info(f"成功访问 {domain}，当前URL: {current_url}")
                      
                  except Exception as e:
                      logger.error(f"Chrome DNS解析 {domain} 失败: {str(e)}")
              
              driver.quit()
              logger.info("Chrome DNS测试完成")
              
          except Exception as e:
              logger.error(f"Chrome浏览器DNS测试失败: {str(e)}")
          EOF
          
          # 运行测试脚本
          python3 test_chrome_dns.py || echo "Chrome DNS测试脚本运行失败，但继续执行工作流"

      # 步骤8: 跳过检查CI环境预装包（脚本已删除）
      - name: 跳过检查CI环境预装包
        run: |
          echo "=== 跳过CI环境预装包检查（脚本已删除）==="

      # 步骤9: 安装Python依赖
      - name: 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install webdriver-manager

          python3 -c "import requests; print('Python3 requests安装成功')" || echo "Python3 requests导入失败"
          python3 -c "import selenium; print('Python3 selenium安装成功')" || echo "Python3 selenium导入失败"
          python3 -c "import easyocr; print('Python3 easyocr安装成功')" || echo "Python3 easyocr导入失败"

      # 步骤10: 运行太阳能数据爬虫
      - name: 运行太阳能数据爬虫
        env:
          HUAWEI_USERNAME: ${{ secrets.HUAWEI_USERNAME }}
          HUAWEI_PASSWORD: ${{ secrets.HUAWEI_PASSWORD }}
          SEMS_USERNAME: ${{ secrets.SEMS_USERNAME }}
          SEMS_PASSWORD: ${{ secrets.SEMS_PASSWORD }}
          ESOLAR_USERNAME: ${{ secrets.ESOLAR_USERNAME }}
          ESOLAR_PASSWORD: ${{ secrets.ESOLAR_PASSWORD }}
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

          echo "=== 检查Python环境 ==="
          which python3
          python3 --version
          python3 -c "import sys; print('Python3路径:', sys.executable)"
          python3 -c "import requests; print('Python3 requests模块可用')" || echo "ERROR: requests模块不可用"

          echo "=== 运行爬虫脚本 ==="
          python3 update_solar_dashboard.py || {
            echo "ERROR: 脚本运行失败"
            exit 1
          }

      # 步骤11: 检查数据更新
      - name: 检查数据更新
        run: |
          if [ -s solar_data.json ]; then
            echo "数据文件存在且不为空"
            cat solar_data.json
          else
            echo "数据文件不存在或为空，退出工作流"
            exit 1
          fi

      # 步骤12: 提交更新的数据文件到仓库
      - name: 提交数据更新
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add solar_data.json screenshots/ data/
          git status

          if ! git diff --staged --quiet; then
            git commit -m "自动化更新太阳能数据 $(date +'%Y-%m-%d %H:%M:%S')"
            # 使用 GITHUB_TOKEN 推送
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
            echo "数据已成功更新并推送到仓库"
          else
            echo "没有检测到数据更改，跳过提交"
          fi
